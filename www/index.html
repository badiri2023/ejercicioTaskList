<!DOCTYPE html>
<html lang="ca"> 
<head>
  <meta charset="utf-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Tasklist AMS2</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://ssl.gstatic.com 'unsafe-eval';
  style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
  <link rel="stylesheet" href="css/index.css" />
  <script src="js/jquery-3.7.1.min.js"></script>
</head>
<body>
  <header>
    <h1>Tasklist</h1>
    <div id="editModeLabel" class="editLabel"></div>
 
  </header>

  <!-- Contenedor de tareas -->
  <div class="container">
    <ul id="taskList">
      <!-- Tarea de ejemplo inicial -->
   <!--   <li>
        <span class="taskText">test task</span>
        <button class="deleteBtn" onclick="eliminar(event)">X</button>
      </li>-->
    </ul>
  </div>

  <!-- Formulario para añadir nueva tarea -->
  <div id="taskFormContainer">
    <input type="text" id="taskInput" placeholder="Escriu la teva tasca..." />
    <button id="addTask">Afegir</button>
  </div>

  <!-- Botones de acción -->
  <footer>
    <button id="btnNew">Nova tasca +</button> 
    <button id="btnEdit">Editar Taska</button> 
  </footer>

  <script>
    // booleano para el modod edicion
    let edicion = false; 

    // Mostrar/ocultar el formulario de nueva tarea
    $('#btnNew').on('click', function () {
      if (edicion) return; 
      $('#taskFormContainer').slideToggle();
    });

    // Activar o desactivar modo edición
    $('#btnEdit').on('click', function () {
      edicion = !edicion;
      $('#editModeLabel').text(edicion ? 'Editing mode ' : '');

      // oculta el formulario si estaba abierto
       if (edicion) {
          $('#taskFormContainer').slideUp(); 
        }
      // Recorre cada tarea para cambiar los botones
      $('#taskList li').each(function () {
        if (edicion) {
          // Si estamos en modo edición, reemplazamos el botón de eliminar por uno de editar
          const acceptBtn = $('<button class="acceptBtn">Editar</button>');
          acceptBtn.on('click', function () {
            const li = $(this).closest('li');
            const span = li.find('.taskText');

            // Si ya hay un input, lo convertimos en texto
            if (li.find('input').length) {
              const nuevoTexto = li.find('input').val();
              const nuevoSpan = $('<span class="taskText"></span>').text(nuevoTexto);
              li.find('input').replaceWith(nuevoSpan);
              $(this).text('Editar');
              guardarTareas(); 
            } else {
              // Si hay texto, lo convertimos en input editable
              const textoActual = span.text();
              const input = $('<input type="text" class="editInput" />').val(textoActual);
              span.replaceWith(input);
              input.focus().select();
              $(this).text('Aceptar');
            }
          });

          // intercambiamos el boton de eliminar por el de editar
          $(this).find('.deleteBtn').replaceWith(acceptBtn);
        } else {
            // Convertir el input en texto 
            const input = $(this).find('input.editInput');
            if (input.length) {
              const nuevoTexto = input.val();
              const nuevoSpan = $('<span class="taskText"></span>').text(nuevoTexto);
              input.replaceWith(nuevoSpan);
            }

            // Reemplazar boton de editar por boton de borrar
            const deleteBtn = $('<button class="deleteBtn">X</button>');
            deleteBtn.on('click', eliminar);
            $(this).find('.acceptBtn').replaceWith(deleteBtn);
          }
      });
    });

    // Añadir nueva tarea
    $('#addTask').on('click', function () {
      if (edicion) return;
      // Obtenemos el texto del input
      const text = $('#taskInput').val().trim(); 
      if (text) {
        // Creamos el elemento <li> con el texto y botón de eliminar
        const elem = $('<li>' +
          '<span class="taskText">' + text + '</span>' +
          '<button class="deleteBtn" onclick="eliminar(event)">X</button>' +
        '</li>');

        // Añadimos evento de eliminar
        elem.find('.deleteBtn').on('click', eliminar);

        // Añadimos evento de editar si se activa el modo edición
        elem.find('.acceptBtn').on('click', function () {
          const li = $(this).closest('li');
          const span = li.find('.taskText');

          if (li.find('input').length) {
            const nuevoTexto = li.find('input').val();
            const nuevoSpan = $('<span class="taskText"></span>').text(nuevoTexto);
            li.find('input').replaceWith(nuevoSpan);
            $(this).text('Editar');
            guardarTareas();
          } else {
            const textoActual = span.text();
            const input = $('<input type="text" class="editInput" />').val(textoActual);
            span.replaceWith(input);
            input.focus().select();
            $(this).text('✔');
          }
        });

        // Añadimos la tarea a la lista
        $('#taskList').append(elem);
        // Limpiamos el campo
        $('#taskInput').val(''); 
        // Ocultamos el formulario
        $('#taskFormContainer').slideUp(); 
        // Guardamos la tarea
        guardarTareas(); 
      }
    });

    // Guardar todas las tasks en localStorage mediante el json.stringify
    function guardarTareas() {
      const tareas = [];
      $('#taskList li').each(function () {
        const texto = $(this).find('.taskText').text();
        // Guardamos solo el texto
        tareas.push({ texto });
      });
      localStorage.setItem("tareas", JSON.stringify(tareas)); 
    }

    // Recuperar tareas guardadas al cargar la página
    function recuperarTareas() {
      const tareasGuardadas = JSON.parse(localStorage.getItem("tareas")) || [];
      tareasGuardadas.forEach(tarea => {
        // Creamos la tarea guardada de nuevo
        const elem = $('<li>' +
          '<span class="taskText">' + tarea.texto + '</span>' +
          '<button class="deleteBtn">X</button>' + '</li>');

        // Añadimos eventos a los botones
        elem.find('.deleteBtn').on('click', eliminar);

        // Añadimos la tarea a la lista
        $('#taskList').append(elem);
      });
    }

    // Eliminar tarea y guardando el estado de la lsita de tareas
    function eliminar(event) {
      $(event.target).closest('li').remove(); 
      guardarTareas(); 
    }

    // recupera los datos guardados
    $(document).ready(function () {
      recuperarTareas();
    });
  </script>
</body>
</html>
